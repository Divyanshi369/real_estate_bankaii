# -------------------------------------------------
# 1. Disable directory listing
# -------------------------------------------------
Options -Indexes

# -------------------------------------------------
# 2. Enable rewrite engine
# -------------------------------------------------
RewriteEngine On

# -------------------------------------------------
# 3. Make /public the web root
# -------------------------------------------------
# If request doesn't already start with /public, redirect there
RewriteCond %{REQUEST_URI} !^/public/
RewriteRule ^(.*)$ public/$1 [L]

# -------------------------------------------------
# 4. Allow real files and directories directly
# -------------------------------------------------
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# -------------------------------------------------
# 5. Route everything inside /public to index.php
# -------------------------------------------------
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^ index.php [L]

# -------------------------------------------------
# 6. Pretty URL for login (optional)
# -------------------------------------------------
# Redirect /public/index.php to /
RewriteCond %{THE_REQUEST} /public/index\.php [NC]
RewriteRule ^public/index\.php$ / [R=301,L]

# -------------------------------------------------
# 7. Block access to sensitive directories
# -------------------------------------------------
RewriteRule ^(config|includes|sql)/ - [R=404,L]

# -------------------------------------------------
# 8. Block sensitive files
# -------------------------------------------------
<FilesMatch "\.(env|ini|log|sql|sh|bat|md)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
</FilesMatch>

<FilesMatch "^(composer\.json|composer\.lock|package\.json|yarn\.lock|phpunit\.xml|\.gitignore)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
</FilesMatch>

# -------------------------------------------------
# 9. Extra security headers
# -------------------------------------------------
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
    Header always set X-XSS-Protection "1; mode=block"
</IfModule>

# -------------------------------------------------
# 10. Fix JFIF images
# -------------------------------------------------
AddType image/jpeg .jfif
